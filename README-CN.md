# FORM REPL 使用手册

FORM 计算机代数系统的交互式读取-求值-打印循环（REPL）。

## 目录

1. [安装](#安装)
2. [快速开始](#快速开始)
3. [命令行选项](#命令行选项)
4. [用户界面](#用户界面)
5. [输入方法](#输入方法)
6. [REPL 命令](#repl-命令)
7. [示例](#示例)
8. [技巧和提示](#技巧和提示)
9. [配置](#配置)
10. [系统要求](#系统要求)

---

## 安装

### 前置条件

- Rust 1.70 或更高版本
- FORM 可执行文件（`sources/form` 或在 PATH 中）

### 编译 FORM

如果 FORM 尚未编译：

```sh
cd /path/to/form-4.3.1-x86_64-osx/src/form
cd ..
autoreconf -i
./configure
make
```

### 编译 REPL

```sh
cargo build --release
```

二进制文件位于 `target/release/form-repl`。

---

## 快速开始

```sh
# 启动 REPL
./target/release/form-repl

# 启用语法高亮
./target/release/form-repl --highlight

# 使用特定主题
./target/release/form-repl --highlight --theme monokai
```

---

## 命令行选项

```
form-repl [选项]

选项:
  --highlight, -h    启用语法高亮
  --theme, -t 名称   设置颜色主题（默认, solarized-dark, monokai, dracula）
  --verbose, -v      启用详细调试输出
  --help, -H         显示此帮助信息
```

### 主题选项

| 主题 | 描述 |
|------|------|
| `default` | 无颜色（单色） |
| `solarized-dark` | Solarized 深色主题（蓝色提示符，绿色输出，红色错误） |
| `monokai` | Monokai 配色方案（橙色提示符，绿色输出，粉色错误） |
| `dracula` | Dracula 主题（紫色提示符，绿色输出，粉色错误） |

### 示例

```sh
form-repl                     # 基础模式（无颜色）
form-repl --highlight         # 启用颜色
form-repl --theme monokai     # Monokai 主题
form-repl --verbose           # 启用调试输出
form-repl --help              # 显示帮助信息
```

---

## 用户界面

### 提示符样式

REPL 使用基于会话的提示符，带有水平分隔线：

```
────────────────────────────────────────
[1] > Symbol x;
... > Local E = x^2 + 1;
... > Print;
────────────────────────────────────────
[2] > ...
```

- **`[N] >`** - 会话提示符（第一行输入，N = 会话编号）
- **`... >`** - 继续提示符（同一会话中的后续行）
- **`────────────────────────────────────────`** - 会话分隔符

### 视觉布局

```
────────────────────────────────────────
[1] > CFunction f;              [会话 1，第一行]
... > Symbol x;                 [继续行]
... > Local E = f(1,2,x,3,4);   [继续行]
... > .end                      [使用 .end 提交]
   E =
      f(3,4,1,2);
────────────────────────────────────────
[2] >                           [新会话，准备输入]
```

### 颜色编码（使用 `--highlight`）

| 区域 | 颜色 | 示例 |
|------|------|------|
| 会话提示符 | 主题依赖 | `[1] >`（monokai 中为橙色） |
| 继续提示符 | 主题依赖 | `... >`（monokai 中为黄色） |
| 输出 | 绿色 | 表达式结果 |
| 错误 | 粉色/粗体 | 错误消息 |
| 分隔符 | 主题提示符颜色 | 水平线 |

---

## 输入方法

### 多行输入

REPL 使用 **`.end`** 提交多行输入：

1. **输入一行并按 Enter** → 添加到输入缓冲区，继续下一行
2. **单独一行输入 `.end`** → 提交所有缓冲的输入到 FORM
3. **在空行按 Enter** → 提交所有缓冲的输入（替代方法）
4. **按 Ctrl+D** → 立即提交（如果输入缓冲区有内容）

### 输入完成流程

```
────────────────────────────────────────
[1] > Symbol x;            [按 Enter]
... > Local E = x^2;       [按 Enter]
... > Print;               [按 Enter]
... > .end                 [使用 .end 提交]
   E =
      x^2;
────────────────────────────────────────
[2] >
```

### 重要说明

- 每行输入会自动去除首尾空白
- `.end` 指令用于提交（与自动添加的早期版本不同）
- 每个会话都有唯一的会话编号用于参考

---

## REPL 命令

所有 REPL 命令以点（`.`）开头，必须在输入的第一行输入。

| 命令 | 描述 | 示例 |
|------|------|------|
| `.help` | 显示帮助信息 | `[1] > .help` |
| `.quit` | 退出 REPL | `[1] > .quit` |
| `.exit` | 退出 REPL（`.quit` 的别名） | `[1] > .exit` |
| `.clear` | 清除当前输入缓冲区 | `[1] > .clear` |

### 命令详情

#### `.help`

显示包含所有可用命令和使用说明的帮助信息。

```
────────────────────────────────────────
[1] > .help
FORM REPL - 多行输入模式
  - 输入语句，按 Enter 继续下一行
  - 在空行按 Enter 提交，或输入 .end
  - 输入 .help 获取命令，.quit 退出

可用命令:
  .help   - 显示此帮助
  .quit   - 退出 REPL
  .clear  - 清除输入缓冲区
────────────────────────────────────────
[2] >
```

#### `.quit` / `.exit`

优雅地退出 REPL。

```
────────────────────────────────────────
[1] > .quit
再见！
```

#### `.clear`

清除当前输入缓冲区并重置行计数器。如果在输入多行表达式时出错，此命令很有用。

```
────────────────────────────────────────
[1] > Symbol x;
... > Local E = x^10;
... > 错误语句
... > .clear       [清除缓冲区，重新开始]
────────────────────────────────────────
[2] >
```

---

## 示例

### 示例 1：基本算术

```
────────────────────────────────────────
[1] > Symbol x;
... > Local E = x^2 + 2*x + 1;
... > Print;
... > .end
   E =
      x^2 + 2*x + 1;

  0.00 sec out of 0.00 sec
────────────────────────────────────────
[2] >
```

### 示例 2：模式匹配

```
────────────────────────────────────────
[1] > CFunction f;
... > Symbol x;
... > Local E = f(1,2,x,3,4);
... > id f(?a,x,?b) = f(?b,?a);
... > Print;
... > .end
   E =
      f(3,4,1,2);

  0.00 sec out of 0.00 sec
────────────────────────────────────────
[2] >
```

### 示例 3：使用 Repeat 的斐波那契

```
────────────────────────────────────────
[1] > Symbol x,n;
... > Local E = x^10;
... > repeat id x^n?{>1} = x^(n-1) + x^(n-2);
... > Print;
... > .end
   E =
      34 + 55*x;

  0.00 sec out of 0.00 sec
────────────────────────────────────────
[2] >
```

### 示例 4：多语句会话

```
────────────────────────────────────────
[1] > Symbol x,y;
... > Local A = x + y;
... > Local B = x - y;
... > Print A, B;
... > .end
   A =
      x + y;

   B =
      x - y;

  0.00 sec out of 0.00 sec
────────────────────────────────────────
[2] >
```

### 示例 5：错误处理

```
────────────────────────────────────────
[1] > Symbol x;
... > Local E = x^;
... > .end
错误: FORM 退出，状态：exit status: 1
────────────────────────────────────────
[2] >
```

### 示例 6：粘贴多行代码

您可以直接将多行 FORM 代码粘贴到 REPL 中：

```
────────────────────────────────────────
[1] > CFunction f;
... > Symbol x;
... > Local E = f(1,2,x,3,4);
... > id f(?a,x,?b) = f(?b,?a);
... > Print;
... > .end
   E =
      f(3,4,1,2);

  0.00 sec out of 0.00 sec
────────────────────────────────────────
[2] >
```

---

## 技巧和提示

### 1. 使用命令历史记录

- **上/下箭头** - 在历史命令之间导航
- 历史记录在当前会话内保留
- 使用历史记录召回和修改之前的 FORM 表达式

### 2. 行编辑

REPL 使用 `rustyline` 提供完整的行编辑功能：

| 按键 | 操作 |
|------|------|
| **左/右箭头** | 按字符移动光标 |
| **Ctrl+A** | 移动到行首 |
| **Ctrl+E** | 移动到行尾 |
| **退格键** | 删除前一个字符 |
| **Ctrl+D** | 删除光标处字符（如果行为空则提交） |
| **Ctrl+L** | 清除屏幕 |
| **Ctrl+C** | 取消当前输入 |

### 3. 高效的多行输入

一次输入所有行而不等待输出：

```
────────────────────────────────────────
[1] > Symbol x,y;
... > Local E = (x+y)^5;
... > expand;
... > Print;
... > .end                 [一次性提交全部]
────────────────────────────────────────
[2] >
```

### 4. 取消输入

按 **Ctrl+C** 取消当前输入并重新开始：

```
────────────────────────────────────────
[1] > Symbol x;
... > Local E = x^100;
... > ^C       [取消并清除缓冲区]
────────────────────────────────────────
[1] >
```

### 5. 调试模式

使用 `--verbose` 标志查看调试信息：

```sh
./target/release/form-repl --verbose
```

---

## 配置

### 环境变量

| 变量 | 描述 |
|------|------|
| `FORM_PATH` | FORM 可执行文件路径（覆盖自动检测） |

### 终端要求

为获得最佳体验，请使用支持以下功能的终端：

- ANSI 转义码（使用 `--highlight` 时显示颜色）
- 原始模式终端输入（大多数现代终端）
- 256 色模式（主题颜色）

推荐终端：

- iTerm2（macOS）
- Terminal.app（macOS）
- GNOME Terminal（Linux）
- Windows Terminal（Windows）
- Alacritty（跨平台）

---

## 系统要求

### 操作系统

- **操作系统**: macOS、Linux 或 Windows（通过 WSL）
- **内存**: 最小（REPL 是轻量级）
- **磁盘**: 约 5 MB（二进制文件）

### 软件依赖

- **Rust**: 1.70.0 或更高版本
- **FORM**: 4.0 或更高版本（随此发行版提供）

### 可选依赖

为获得完整功能：

- **GMP** - 任意精度算术
- **MPFR** - 浮点算术
- **zlib/zstd** - 压缩

这些是 FORM 的依赖项，不是 REPL 的依赖项。

---

## 故障排除

### "找不到 FORM 可执行文件"

确保 FORM 已编译：

```sh
cd /path/to/form-4.3.1-x86_64-osx/src/form
make
```

或手动指定路径：

```sh
export FORM_PATH=/path/to/form
./target/release/form-repl
```

### 颜色不工作

1. 确保终端支持 ANSI 颜色
2. 尝试其他主题：
   ```sh
   form-repl --highlight --theme default
   ```
3. 检查终端设置中的 256 色支持

### 输入不可见

- 确保终端支持原始模式
- 尝试不使用 `--highlight` 标志
- 检查 stdin 是否为 TTY

### 性能问题

- 使用发布版本：`cargo build --release`
- 如果速度慢，禁用高亮： `./form-repl`（不带 `--highlight`）

---

## 另请参阅

- [FORM 官方网站](http://www.nikhef.nl/~form)
- [FORM GitHub 仓库](https://github.com/vermaseren/form)
- [FORM 手册](https://github.com/vermaseren/form/releases)
